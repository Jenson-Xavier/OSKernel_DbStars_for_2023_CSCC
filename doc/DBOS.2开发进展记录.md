这里根据大赛要求，简单附上我们在设计操作系统内核过程中的一些阶段性的进展，其中会提及一些我们遇到的问题和解决的方法，以时间线的展开来说明。<br />`2023.4.23`：这个时候完成了操作系统内核设计中的异常和中断的设计和部署，并且利用sbi固件提供的接口参考C++中的cout对象的设计，简单实现了用于打印相关信息方便后面调试的自己的kout对象，并且成功在系统中引入了时钟中断，完成了裸机输出“hello,world”的实现。<br />`2023.5.1`：这个时候主要是利用链表管理的方式，采用分页设计，以标准的4KB大小为一个页大小进行设计，相较于后面的虚拟内存（sv39的机制的引入）的实现，我们在初期先较为轻松地实现了物理内存的分配，并实现了自己的kmalloc和kfree，这为后面设计进程链表可以先提供方便。<br />`2023.5.3`：这个时候初步完成了对于进程管理对象的设计，初步给出了进程控制块的结构体内容，并编写了进程管理器的相关接口，进程管理有了初步的雏形了，主要实现了内核的分配、初始化、状态设计、回收，进程链表的维护，以及意义上代替内核执行的boot根进程的创建和初始化。<br />`2023.5.6`：这个时候是实现了进程调度的初步逻辑内容，主要还是在内核区进程内核进程（或者叫内核线程）的调度和设计，能够在内核态启动一个进程，并且让他跳转到执行具体的函数然后退出。由于是在内核态的设计，所以这里并没有出现很棘手的问题，主要是要搞清楚进程调度的逻辑，这里是采用时间片轮转RR调度算法，也就是利用时钟中断来实现进程的切换，进程的切换最关键的就是维护上下文，也就是维护好通用寄存器和控制状态寄存器的切换和保存，跳转逻辑也是借助了汇编文件代码的编写实现，具体设计逻辑可以参看代码。<br />`2023.5.10`：这个时候我们终于理清了虚拟内存管理的机制，并且通过VMR和VMS的逻辑设计实现了虚拟内存管理机制，同时在原有的进程管理设计进一步做了扩充和修改，丰富了进程调度的逻辑，修改了一些初期代码的bug，改善了一些初期设计的不足并在代码中做出了一些修改。除了进程和内存管理部分之外，这个时间段下我们也是完成了同步原语的设计，考虑到后期临界区或者像wait这样的调用的需要，主要实现了自旋锁、互斥锁和信号量，具体设计逻辑可以参看后面“同步原语”一节。同时有了虚拟内存管理的机制，可以准备实现用户进程了，于是给整个内核的中断trap入口点的汇编处理代码做了修改，增加了U态和S态切换所需要做的有关栈指针的切换和处理。<br />`2023.5.20`：这个时候初步实现了用户进程启动的逻辑，本质上就是让一个内核文件之外的C/C++代码的主函数文件能够执行，并且相关函数需要使用内核提供的系统调用接口实现，最初我们只是用能够输出相关内容的输出系统调用去实现测试。当然由于文件系统还没有完成设计，所以我们使用了编译的技术讲用户程序编译得到的可执行文件嵌入内核中，从内核中找到相关的地址得到执行的文件流，然后为用户编写连接脚本进行装载从而运行。当然说起来就是这么多的内容，但是这里遇到了许多难调的bug，比如为了将用户程序嵌入内核，我们就查阅了很多资料，调试了很久，然后之后出现了很多次启动进程后执行用户代码的异常，最后除了是启动逻辑有一点代码上的漏洞之外，理解不深刻导致没有将嵌入内核的那段执行流文件在内存上拷贝到用户链接脚本位置的启动地址处，当时调试了非常久，也是我们第一次遇到这样的bug，事实上后面还遇到了非常多次这样的bug。<br />`2023.5.29`：到这里我们的时间就已经很紧张了，我们紧急讨论分析设计了接下来的开发方案，这个时候主要初步完成了文件系统的整体框架和代码编写的任务，但是对于文件驱动的问题还没有解决，后来我们采用了先使用ramdisk的方式在本地将测试用例的镜像编译成我们的udisk磁盘镜像进行本地测试，然后继续完成文件系统充分全面接口的编写，同时开始系统调用的函数编写，一共需要30个左右的系统调用函数的编写，在这个时候主要实现了进程部分和其他像时间管理部分的系统调用的编写。同时进程管理部分进一步扩展了功能接口和逻辑实现，同步汇编代码的编写和相关逻辑设计实现了让用户进程从某个指定函数启动的功能，为后面解析ELF文件运行用户进程提供了支持。<br />`2023.6.3`：这个时候主要是在进程增加了文件描述符的接口，同时完成了ELF文件的解析、装载和运行，同时文件系统的接口也已经基本实现，可以正确进行ELF文件的解析并且能装载进程并跳转执行的功能，不过这里出现了超级多的bug，就是解析ELF文件并执行的过程，每个bug都是调试完了又出现一个新的，具体已经难以说明了，大概记得主要的问题出现在解析ELF文件相关结构体变量的位置安放错误导致读取时不同的变量被赋予了错误的信息，以及文件读写的接口因为代码的错误逻辑和漏洞导致文件错误读取信息产生bug，还有一些是初期代码不成熟的逻辑导致出错的，当时调试这些bug几乎到了废寝忘食的地步，不过所幸最终找到了问题所在。同时扩展实现了大部分之前没有实现的系统调用，基本上在这个时候的两天内顺利基于ramdisk技术在本地测试正常通过了20个左右的系统调用。<br />`2023.6.7`：在大赛的最后一天，经历连续了三到四天的高强度调试之后，我们终于在大赛截止前提交了几次测试，并且将已经实现的系统调用均尽全力调试通过，对我们的内核设计初赛暂时告一段落了。<br />By：谢骏鑫
